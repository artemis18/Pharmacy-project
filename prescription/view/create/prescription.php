<?php    require_once "control/validsession.php";    require_once("database/database.php");    $con = mysql_connect($db_host, $db_username, $db_password);    $db = mysql_select_db($db_database, $con);?><script language="Javascript" src="/prescription/js/form_creation.js"></script><script language="Javascript" src="/prescription/js/livesearch.js"></script><script language="Javascript" src="/prescription/js/endorsement.js"></script><script language="Javascript" src="/prescription/js/liveview.js"></script><h1>Prescription Form</h1><div style="float: left;"><form action="" method="post" id="prescriptionform">    <fieldset>        <legend>Create a prescription form</legend>        <table>            <tr>                <td colspan="3">&nbsp;</td>            </tr>            <tr>                <td align="right"><label>Create From New?:</label></td>                <td colspan="2">&nbsp;                    <label for="yes">Yes</label>                    <input type="checkbox"                            name="new"                            value="yes"                            id="selectyes"                            checked="true"                           onclick="createNew();"/>                    &nbsp;                    <button type="button"                             id="selectnew"                            disabled="disabled"                            onclick="showElementCenter('select_prescription');"                             name="selectnew">Select...</button>                    <input type="hidden" name="selectedid" value="" id="selectedid"/>                    <br/>                    <span id="selected_id"></span>                    <div style="float: right; text-align: right;">                        Type:                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                        <label for="correct">Correct:</label><input checked="true" type="radio" id="correct" name="type" value="correct"/><br/>                        <label for="incorrect">Incorrect:</label><input type="radio" id="incorrect" name="type" value="incorrect"/>                    </div>                                    </td>            </tr>            <tr>                <td colspan="3">&nbsp;</td>            </tr>            <tr>                <td align="right"><label>Show:</label></td>                <td>                    <div style="text-align: right;">                        <label for="show_signature">Signature</label>                        <input type="checkbox"                                name="show_signature"                                value="yes"                                checked="true"                               id="show_signature"                               onclick="updateCanvas();"/>                        &nbsp;                        <label for="show_stamp">Pharmacy Stamp</label>                        <input type="checkbox"                                name="show_stamp"                                value="yes"                                checked="true"                               id="show_stamp"                               onclick="updateCanvas();"/>                        <br/>                        <label for="show_ndt">No. Days' Treatment</label>                        <input type="checkbox"                                name="show_ndt"                                value="yes"                                checked="true"                               id="show_ndt"                               onclick="updateCanvas();"/>                        &nbsp;&nbsp;&nbsp;                        <label for="show_date">Date</label>                        <input type="checkbox"                                name="show_date"                                value="yes"                                checked="true"                               id="show_date"                               onclick="updateCanvas();"/>                        <br/>                        <label for="show_dob">D.O.B</label>                        <input type="checkbox"                                name="show_dob"                                value="yes"                                checked="true"                               id="show_dob"                               onclick="updateCanvas();"/>                        &nbsp;&nbsp;                        <label for="show_age">Age</label>                        <input type="checkbox"                                name="show_age"                                value="yes"                                checked="true"                               id="show_age"                               onclick="updateCanvas();"/>                        &nbsp;&nbsp;                        <label for="show_nhs">NHS No.</label>                        <input type="checkbox"                                name="show_nhs"                                value="yes"                                checked="true"                               id="show_nhs"                               onclick="updateCanvas();"/>                    </div>                                    </td>            </tr>            <tr>                <td>&nbsp;</td>            </tr>            <tr>                <td align="right"><label>Watermark:</label></td>                <td>                    <div style="text-align: right;">                        <label for="w_nhs">NHS</label>                        <input type="radio"                               name="watermark"                               value="nhs"                               checked="true"                               id="w_nhs"                               onchange="updateCanvas();"/>&nbsp;                        <label for="w_pcd">Private CD</label>                        <input type="radio"                               name="watermark"                               value="pcd"                               id="w_pcd"                               onchange="updateCanvas();"/>&nbsp;                        <label for="w_none">None</label>                        <input type="radio"                               name="watermark"                               value="none"                               id="w_none"                               onchange="updateCanvas();"/>                    </div>                </td>            </tr>            <tr>                <td align="right"><label>Patient:</label></td>                <td><input type="text"                            style="color: #ddd;"                           value="Click on Show"                           name="patient"                            id="patient"                            readonly="readonly"                            onfocus="this.blur();"/><br/></td>                <td><button type="button" onclick="showElementCenter('add_patient');">Show</button></td>            </tr>            <tr>                <td align="right"><label>Endorsements:</label></td>                <td><select size="5"                             id="endorsements"                             name="endorsements[]"                             style="width: 100%;"                             readonly="readonly"                             onfocus="this.blur();"                            multiple="multiple">                        <option style="color: #ddd;">Click on Show</option>                </select></td>                <td><button type="button" onclick="showElementCenter('add_endorsements');">Show</button></td>                            </tr>            <tr>                <td align="right"><label>Number of days treatment</label></td>                <td><input type="text"                           style="color: #000;"                           value=""                           name="num_days"                           id="num_days"                           size="3"                           onKeyUp="updateCanvas();"                           />                </td>                <td></td>            </tr>            <tr>                <td align="right"><label>Prescriber:</label></td>                <td><input type="text"                            name="prescriber"                            id="prescriber"                            style="color: #ddd;"                           value="Click on Show"                           readonly="readonly"                            onfocus="this.blur();"/></td>                <td><button type="button" onclick="showElementCenter('add_prescriber');">Show</button></td>                            </tr>            <tr>                <td align="right"><label>Layout:</label></td>                <td><input type="text"                            name="layout"                            style="color: #ddd;"                           value="Click on Show"                           id="layout"                            readonly="readonly"                            onfocus="this.blur();"/></td>                <td><button type="button" onclick="showElementCenter('add_layout');">Show</button></td>                           </tr>            <tr>                <td></td>                <td align="left" colspan="2">                    <br/>                    <p style="font-size: 13px;">                    This feedback will be displayed to the student after<br/>                    they have completed the test.                    </p>                </td>                     </tr>            <tr>                <td align="right"><label>Feedback Note:</label></td>                <td colspan="2"><textarea width="200px" name="feedback" id="feedback"></textarea></td>                          </tr>            <tr>                <td></td>                <td>                    <!--<input type="hidden" name="endorsements"/>-->                    <input name="submit" type="submit" value="Submit"/>                </td>            </tr>        </table>    </fieldset></form><span id="messages" class="incorrect"></span></div><div style="margin-left: 10px; float: right; display: inline-block;">    10% <input type="range"                id="scale"                value="100"                min="10"                max="100"               step="10"                onChange="updateCanvas(this.value/100);"/> 100%<br/>                <canvas id="liveCanvas" width="450" height="600" class="canvas_display"></canvas></div><!-- Div element for background blackening --><div id="bg" style="visibility:hidden;                     background: #000;                     position: absolute;                     width: 0px;                     height:0px;                     z-index: 2;                     opacity: 0.4;                     margin: auto;                     top: 0px;                     left: 0px;"></div><div id="add_layout" class="submit_box rnd_corner" style="visibility: hidden;">    <div style="width: 410px;">        <div style="">            <h1>Select Layout</h1>            <label>Search:</label>            <input type="text" id="layout_search" onKeyUp="liveLayouts(this.value);"/>            <select style=" vertical-align: top;                            width: 200px;                             margin-left: 2px;"                     size="7"                     name="layouts"                     id="livelayouts"                    onChange="displayLayout(this.value)">            </select>        </div>    </div>    <b>ID: </b><label id="layout_id"></label><br/>    <b>Name: </b><label id="layout_name"></label><br/>    <canvas id="layout_preview"             width="225"             height="300"            class="canvas_display">Your browser does not support Canvas.</canvas>    <br/>    <button type="button" onclick="submitLayout();">Submit</button>    <button type="button" onclick="hideElementCenter('add_layout');">Hide</button>    </div><!-- Div element to allow selection of already present prescriptions --><div id="select_prescription" class="submit_box rnd_corner" style="visibility: hidden; position: absolute;">    <table>        <tr>            <td>                <div style="float: left">                    <h1>Select Prescription Form</h1>                    <label>Search:</label><br/>                    <input id="prescriptionsearch"                            type="text"                            name="prescriptionsearch"                            onKeyUp="livepformsearch();"/>                    <select id="select_field" onChange="livepformsearch();">                        <option value="pformid">Prescription ID</option>                        <option value="patient">Patient</option>                        <option value="prescriber">Prescriber</option>                        <option value="endorsement">Endorsement</option>                    </select><br/>                    <label id="num_results">Found:</label>                    <br/><br/>                    Sort By Date?:                    <input type="checkbox"                            name="sortby"                            value="date"                            id="sortby_date"                            onclick="livepformsearch();"/>                    <label for="sortby_date">Yes</label>                    <br/>                    <select id="livepform"                             style="vertical-align: top;                                    width: 100%;"                             size="15"                             onChange="pformdisplay(this.value);">                    </select>                    <br/>                    <span class="correct">Correct Prescription</span><br/>                    <span class="incorrect">Incorrect Prescription</span>                </div>                <div style="float:right; margin: 70px 5px 10px 20px;">                    <canvas id="ps_view_c"                             width="450"                             height="600"                             class="canvas_display">Your browser does not support Canvas.</canvas>                </div>            </td>        </tr>    </table>    <button type="button" onclick="submitSelection();">Select</button>    <button type="button" onclick="hideElementCenter('select_prescription');">Hide</button></div><div id="add_endorsements" class="submit_box rnd_corner" style="visibility: hidden;">    <table>        <tr>            <td valign="top">                <div style="width: 300px">                    <h1>Select Endorsement</h1>                    <label>Search:</label>                    <input id="query"                            type="text"                            name="search"                            style="width:100%;"                            onkeyup="loadEndorsements(this.value);"/>                    <br/>                    <select id="liveendorsements"                             style="vertical-align: top;                                    width: 100%;"                             size="10"                             name="endorsements[]"                             onChange="endorsementDetails(this.value);">                        <option></option>                    </select>                    <table width="100%">                        <tr>                            <td align="right" colspan="2"><button onclick="addSelected(document.getElementById('liveendorsements').value)">Add -></button></td>                        </tr>                        <tr>                            <td align="left"><b>Drug:&nbsp;</b></td>                            <td align="left"><span id="end_drug"></span></td>                        </tr>                        <tr>                            <td align="left"><b>Quantity:&nbsp;</b></td>                            <td align="left"><span id="end_quantity"></span></td>                        </tr>                        <tr>                            <td align="left"><b>Dosage:&nbsp;</b></td>                            <td align="left"><span id="end_dosage"></span></td>                        </tr>                        <tr>                            <td colspan="3">&nbsp;</td>                        </tr>                                                  </table>                </div>            </td>            <td valign="top" rowspan="2">                <div style="margin-top: 2px;                            margin-left: 20px;">                    <h1>Selected</h1>                    <div style="width: 200px;                                height: 425px;                                border: 1px solid #abadb3;                                background-color: #fff"                         id="selected">                        <ol>                            <li><p class="endorsement_item"><b>1 - <a href="#" onClick="removeSelected('1');">Remove</a></b><br/><span id="endorsement_1">Drug: <br/>Quantity: <br/>Dosage: </span></p></li>                            <li><p class="endorsement_item"><b>2 - <a href="#" onClick="removeSelected('2');">Remove</a></b><br/><span id="endorsement_2">Drug: <br/>Quantity: <br/>Dosage: </span></p></li>                            <li><p class="endorsement_item"><b>3 - <a href="#" onClick="removeSelected('3');">Remove</a></b><br/><span id="endorsement_3">Drug: <br/>Quantity: <br/>Dosage: </span></p></li>                            <li><p class="endorsement_item"><b>4 - <a href="#" onClick="removeSelected('4');">Remove</a></b><br/><span id="endorsement_4">Drug: <br/>Quantity: <br/>Dosage: </span></p></li>                            <li><p class="endorsement_item"><b>5 - <a href="#" onClick="removeSelected('5');">Remove</a></b><br/><span id="endorsement_5">Drug: <br/>Quantity: <br/>Dosage: </span></p></li>                        </ol>                    </div>                    <button type="button" onclick="submitEndorsements();">Submit</button>                    <button type="button" onclick="hideElementCenter('add_endorsements');">Hide</button>                </div>            </td>        </tr>    </table></div><div id="add_patient" class="submit_box rnd_corner" style="visibility: hidden;">    <div style="width: 410px;">        <div style="width: 200px;                    float: left;                    margin-right: 10px;">            <h1>Select Patient</h1>            <label>Search:</label>            <input type="text" id="patient_search" onKeyUp="livePatient(this.value)"/>            <select style=" vertical-align: top;                            width: 200px;                             margin-left: 2px;"                     size="7"                     name="patients"                     id="livepatients"                    onChange="displayPatient(this.value)">            </select>        </div>        <div style="width: 200px;                    float: right;                     margin-top: 2px;">            <img align="left"                  id="avatar"                  src="images/avatar.png"                  alt="Patient avatar"                  width="200" height="200"/>        </div>        <div style="clear: both;"></div>    </div>    <div style="width: 400px; padding: 5px; margin-top: 5px;">         <b>Patient ID: </b><label id="patient_id"></label><br/>         <b>Name: </b><label id="patient_name">Mr J. Brown</label><br/>         <b>Gender: </b><label id="patient_gender">Male</label><br/>         <b>Road: </b><label id="patient_road">283 Jockey rd</label><br/>         <b>City: </b><label id="patient_city">Birmingham</label><br/>         <b>Postcode: </b><label id="patient_postcode">B73 5XE</label><br/>         <b>Telephone: </b><label id="patient_telephone"></label>    </div>        <div style="width: 390px; padding: 10px; margin-top: 5px; background-color: #fff">        <strong>Description</strong>        <p>this is some random text to check that the description container is going to be positioned correctly and have the correct styling</p>    </div>            <button type="button" onclick="submitPatient();">Submit</button>            <button type="button" onclick="hideElementCenter('add_patient');">Hide</button></div><div id="add_prescriber" class="submit_box rnd_corner" style="visibility: hidden;">    <div style="width: 410px;">        <div style="width: 200px; float: left; margin-right: 10px;">            <h1>Select Prescriber</h1>            <label>Search:</label>            <input type="text" id="prescriber_search" onKeyUp="livePrescriber(this.value);"/>            <select style=" vertical-align: top;                            width: 200px;                            margin-left: 2px;"                      size="7"                      name="patients"                     id="liveprescriber"                     onChange="displayPrescriber(this.value);">                <option></option>            </select>        </div>        <div style="width: 200px; float: right; margin-top: 2px;">            <img align="left"                  id="avatar"                  src="images/doctor_avatar.png"                  alt="Patient avatar"                  width="200" height="200" />        </div>        <div style="clear: both;"></div>    </div>    <div style="width: 400px; padding: 5px; margin-top: 5px;">         <b>Prescriber ID: </b><label id="prescriber_id"></label><br/>         <b>Name: </b><label id="prescriber_name">Dr J. Brown</label><br/>         <b>Road: </b><label id="prescriber_road">283 Jockey rd</label><br/>         <b>City: </b><label id="prescriber_city">Birmingham</label><br/>         <b>Postcode: </b><label id="prescriber_postcode">B73 5XE</label>    </div>         <button type="button"                  onclick="submitPrescriber();">             Submit         </button>         <button type="button"                 onclick="hideElementCenter('add_prescriber');">             Hide         </button></div><?php    if(            isset($_POST['submit'])       ){                   $type = $_POST['type'];        $patient_id = mysql_real_escape_string($_POST['patient']);        $prescriber_id = mysql_real_escape_string($_POST['prescriber']);        $layout_id = mysql_real_escape_string($_POST['layout']);        $endorsements = $_POST['endorsements'];        $feedback = mysql_real_escape_string($_POST['feedback']);        $watermark = $_POST['watermark'];        $num_of_days = mysql_real_escape_string($_POST['num_days']);        if(isset($_POST['show_signature'])){            $signature = "true";        }else{            $signature = "false";        }        if(isset($_POST['show_ndt'])){            $ndt = "true";        }else{            $ndt = "false";        }        if(isset($_POST['show_stamp'])){            $stamp = "true";        }else{            $stamp = "false";        }        if(isset($_POST['show_date'])){            $date = "true";        }else{            $date = "false";        }        if(isset($_POST['show_dob'])){            $dob = "true";        }else{            $dob = "false";        }        if(isset($_POST['show_age'])){            $age = "true";        }else{            $age = "false";        }        if(isset($_POST['show_nhs'])){            $nhs = "true";        }else{            $nhs = "false";        }                        $query = "SELECT pf.PrescriptionFormID, pf.Watermark, pf.Stamp,                         pf.PrescriptionLayoutID, pf.Signature, pf.Date,                         pf.PatientID, pf.NDT, pf.NumDaysTreatment,                         pf.PrescriberID, pf.NHSNo, pf.Age, pf.DOB,                         ec.PrescriptionFormID,                         ec.EndorsementID                  FROM   prescriptionforms pf, endorsementcollection ec                  WHERE  pf.PrescriptionLayoutID='{$layout_id}' AND                         pf.PatientID='{$patient_id}' AND                         pf.PrescriberID='{$prescriber_id}' AND                         pf.Watermark='{$watermark}' AND                         pf.NHSNO='{$nhs}' AND                         pf.Age='{$age}' AND                         pf.DOB='{$dob}' AND                         pf.Date='{$date}' AND                         pf.NumDaysTreatment='{$num_of_days}' AND                         pf.Stamp='{$stamp}' AND                         pf.Signature='{$signature}' AND                         pf.NDT='{$ndt}' AND                         pf.PrescriptionFormID=ec.PrescriptionFormID                 ";        //Add all endorsements into query        foreach($endorsements AS $value){            $query = $query . " AND ec.EndorsementID='{$value}' ";        }                $result = mysql_query($query)or die(mysql_error());                if(mysql_num_rows($result) > 0){            echo "<span class=\"incorrect\">Warning: </span>This prescription variation already exists.<br/>";        }        else{            if($type=="correct"){ //New Prescription                $query = "SELECT MAX(PrescriptionFormID)                           FROM   prescriptionforms                     ";                $result = mysql_query($query)or die(mysql_error());                $row = mysql_fetch_array($result);                $prescription_form_id = (substr($row[0],0,-2)+1) * 100;            }            else{ //New Incorrect mutation                $correct_id = mysql_real_escape_string($_POST['selectedid']);                                $min = substr($correct_id, 0, strlen($correct_id)-2) . "00";                $max = $min + 99;                                $query = "SELECT  MAX(PrescriptionFormID)                           FROM    prescriptionforms                          WHERE   PrescriptionFormID                          BETWEEN '{$min}' AND '{$max}'                     ";                $result = mysql_query($query)or die(mysql_error());                $row = mysql_fetch_array($result);                if(substr($row[0], strlen($row[0])-2, 2) < 99 ){                    $prescription_form_id = $row[0] + 1;                }                else{                    $prescription_form_id = "1";                }                $incorrect = true;            }            $now = time();                        $query = "INSERT INTO prescriptionforms                      VALUES                      (                        '{$prescription_form_id}',                        '{$patient_id}',                        '{$prescriber_id}',                        '{$layout_id}',                        '{$feedback}',                        '{$now}',                        '{$watermark}',                        '{$signature}',                        '{$ndt}',                        '{$stamp}',                        '{$date}',                        '{$dob}',                        '{$age}',                        '{$nhs}',                        '{$num_of_days}'                      )                     ";            mysql_query($query)or die(mysql_error());                        foreach($endorsements as $value){                                $query = "SELECT EndorsementID, PrescriptionFormID                          FROM   endorsementcollection                          WHERE  EndorsementID='{$value}' AND                                 PrescriptionFormID='{$prescription_form_id}'                         ";                $result = mysql_query($query)or die(mysql_error());                $num = mysql_num_rows($result);                                if($num > 0){                    echo "<span class=\"incorrect\">Warning:</span> Endorsement ID: {$value} already exists in Prescription.<br/>";                }                else{                    $query = "INSERT INTO endorsementcollection                              VALUES                              (                                '{$value}',                                '{$prescription_form_id}'                              )                             ";                    mysql_query($query)or die(mysql_error());               }            }                        if(isset($incorrect)){                echo "<span class=\"correct\">Success:</span> Prescription Mutation added successfully.<br/>";            }            else{                echo "<span class=\"correct\">Success:</span> Prescription Form added successfully.<br/>";            }                    }    }  ?>